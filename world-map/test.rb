#!/usr/bin/ruby

# Copyright 2014 Douglas Triggs (douglas@triggs.org)
# 
# I reserve no rights to this, if this is useful to anybody, do whatever
# you want to do to it, give me credit or not, I don't care.  I also
# give no warrantee -- if the code breaks for you, you're on your own.

# Tests: make sure the functions do what they say they do

require_relative 'utilities.rb'

# NOTE: You'll need to un-disable validation checks for this to do
# anything useful.

test_polygons = []
# Make some sample polygons
polygon = Polygon.new([Point.new(0.0, 0.0), Point.new(0.75, 0.51),
                       Point.new(0.0, 1.0), Point.new(1.0, 1.0),
                       Point.new(1.0, 0.0)])
test_polygons.push(polygon)
polygon = Polygon.new
0.step(3599,2) do |x|
  if (x == 1)
    polygon.add(Point.new(0.0, 0.0))
  end
  polygon.add(Point.new(10.0 * Math.sin(x / 1800.0 * Math::PI),
                        10.0 * Math.cos(x / 1800.0 * Math::PI)))
end
test_polygons.push(polygon)
polygon = Polygon.new([Point.new(0.0, 0.0), Point.new(1.5, 0.0),
                       Point.new(2.5, -0.5), Point.new(3.0, 2.5),
                       Point.new(2.5, 1.5), Point.new(1.0, 2.2),
                       Point.new(1.0, 1.2)])
test_polygons.push(polygon)
polygon = Polygon.new([Point.new(0.0, 0.0), Point.new(1.0, 0.5),
                       Point.new(1.0, 2.0), Point.new(2.0, 0.01),
                       Point.new(1.0, -2.0), Point.new(0.7, 0.35),
                       Point.new(0.0, 0.0), Point.new(1.5, -3.0),
                       Point.new(3.0, 0.05), Point.new(2.0, 4.0)])

# Shift them around a bit, because floating point! Accuracy! Precision!
all_polygons = []
test_polygons.each do |polygon|
  all_polygons.push(polygon)
  polygon2 = Polygon.new
  polygon3 = Polygon.new
  polygon4 = Polygon.new
  polygon5 = Polygon.new
  shift = 0.1000001
  polygon.points.each do |point|
    polygon2.add(Point.new(point.x + shift, point.y))
    polygon3.add(Point.new(point.x - shift, point.y))
    polygon4.add(Point.new(point.x, point.y + shift))
    polygon5.add(Point.new(point.x, point.y - shift))
  end
  all_polygons.push(polygon2)
  all_polygons.push(polygon3)
  all_polygons.push(polygon4)
  all_polygons.push(polygon5)
end
# A problem polygon
polygon_source = [[132.86701058459033, 18.346747137494162],
                  [132.8691512378963, 18.350104071087827],
                  [132.87110436289635, 18.350287176556577],
                  [132.87134850352123, 18.348578192181577],
                  [132.86927330820873, 18.346747137494162],
                  [132.86701058459033, 18.346747137494162],
                  [132.86701058459033, 18.346747137494162],
                  [132.86646569102118, 18.345892645306577],
                  [132.79786217539635, 18.153326727337884],
                  [132.79163658945873, 18.143988348431662],
                  [132.77173912852135, 18.1406314148378],
                  [132.75794518320868, 18.148871160931577],
                  [132.74805748789635, 18.165533758587884],
                  [132.72449791758373, 18.23444244999402],
                  [132.71265709727123, 18.252997137494162],
                  [132.69556725352118, 18.263983465618992],
                  [132.67493737070868, 18.26343414921277],
                  [132.61207115977135, 18.23676178593155],
                  [132.54200280039618, 18.190130926556634],
                  [132.49048912852118, 18.140570379681492],
                  [132.47962487070868, 18.12000153202527],
                  [132.47291100352123, 18.076605535931606],
                  [132.47584069102118, 18.06842682499422],
                  [132.4907332691463, 18.058722235150384],
                  [132.50171959727123, 18.0490786804628],
                  [132.51417076914618, 18.030890203900412],
                  [132.53284752695868, 17.981695867962742],
                  [132.54896080820885, 17.880804754681492],
                  [132.5516463550838, 17.880011297650412],
                  [132.36182701914635, 17.873663641400356],
                  [132.30738365977118, 17.88141510624405],
                  [132.27320397227123, 17.896063543743992],
                  [132.27076256602118, 17.919073797650356],
                  [132.31165612070885, 17.95197174686902],
                  [132.3637801441463, 17.97791168827527],
                  [132.3899031910213, 17.997137762493992],
                  [132.40015709727135, 18.009466864056606],
                  [132.40772545664618, 18.023993231244134],
                  [132.42945397227118, 18.111578680462742],
                  [132.42689049570885, 18.178534246868992],
                  [132.4065047535213, 18.229986883587884],
                  [132.30311119883385, 18.341986395306492],
                  [132.27613365977118, 18.38208649296277],
                  [132.26356041758368, 18.432013250775242],
                  [132.26685631602135, 18.430487371868992],
                  [132.27491295664623, 18.43170807499405],
                  [132.29749596445868, 18.441107489056606],
                  [132.30799401133368, 18.448736883587856],
                  [132.31519615977123, 18.457892157025356],
                  [132.31702721445885, 18.468451239056492],
                  [132.31165612070885, 18.479986883587827],
                  [132.30054772227118, 18.495550848431606],
                  [132.29493248789618, 18.506781317181492],
                  [132.2905379566463, 18.521246649212884],
                  [132.28675377695873, 18.526922918744106],
                  [132.27869713633385, 18.53314850468152],
                  [132.19117272227118, 18.572149969525356],
                  [132.16016686289618, 18.577643133587827],
                  [132.1196395191463, 18.575995184369134],
                  [132.09742272227118, 18.568304754681577],
                  [131.98780358164635, 18.48053619999405],
                  [131.9687606128963, 18.474737860150242],
                  [131.95167076914618, 18.479986883587827],
                  [131.93604576914618, 18.509955145306606],
                  [131.95521080820885, 18.730231024212827],
                  [131.94044030039618, 18.777411199994134],
                  [131.90186608164623, 18.80817291874402],
                  [131.8315535816463, 18.815985418744106],
                  [131.81214440195885, 18.810736395306606],
                  [131.80359948008368, 18.799200750775356],
                  [131.80298912852135, 18.782782293743992],
                  [131.81641686289623, 18.716742254681634],
                  [131.8159285816463, 18.693609930462827],
                  [131.80762780039623, 18.672064520306577],
                  [131.8037215503963, 18.670172430462856],
                  [131.73560631602118, 18.672064520306577],
                  [131.7091170582088, 18.662176824994106],
                  [131.69336998789623, 18.64911530155652],
                  [131.68592369883373, 18.63403961796277],
                  [131.68433678477135, 18.618475653119106],
                  [131.69031823008373, 18.581000067181606],
                  [131.68763268320868, 18.575995184369134],
                  [131.6606551441463, 18.572211004681492],
                  [131.29346764414618, 18.612738348431577],
                  [131.24207604258368, 18.629706121869077],
                  [131.22230065195868, 18.639715887494162],
                  [131.17725670664623, 18.679388739056662],
                  [131.15821373789618, 18.707220770306634],
                  [131.14991295664635, 18.714972235150327],
                  [131.13990319102118, 18.720404364056492],
                  [131.12732994883368, 18.72235748905652],
                  [131.11158287852135, 18.71997711796297],
                  [131.07276451914618, 18.70575592655652],
                  [131.04481041758385, 18.688482977337856],
                  [131.02613365977135, 18.66840241093155],
                  [131.01514733164623, 18.645575262494106],
                  [131.0102645191463, 18.620001532025356],
                  [131.01563561289635, 18.52802155155655],
                  [131.02527916758368, 18.499701239056634],
                  [131.0791121753963, 18.413336492962742],
                  [131.15650475352118, 18.332037664837884],
                  [131.19520104258373, 18.309881903119106],
                  [131.22950280039623, 18.308966375775384],
                  [131.25562584727123, 18.336004949994106],
                  [131.25648033945868, 18.341498114056662],
                  [131.25367272227135, 18.404059149212912],
                  [131.25562584727123, 18.407965399212912],
                  [131.27051842539623, 18.41339752811905],
                  [131.28455651133385, 18.41376373905655],
                  [131.2973738941463, 18.41034577030655],
                  [131.34192955820868, 18.3861148132753],
                  [131.35169518320885, 18.384039617962827],
                  [131.53809655039618, 18.39191315311922],
                  [131.55591881602118, 18.386908270306577],
                  [131.55665123789618, 18.37372467655655],
                  [131.53736412852123, 18.34967682499405],
                  [131.43580162852135, 18.265021063275327],
                  [131.4209090503963, 18.2583071960878],
                  [131.41065514414635, 18.259344793744106],
                  [131.38624108164635, 18.273993231244077],
                  [131.36341393320873, 18.2823550476503],
                  [131.3276473316463, 18.288031317181606],
                  [131.3140975269588, 18.286688543743992],
                  [131.28089440195868, 18.27442047733797],
                  [131.24952233164623, 18.256720282025412],
                  [131.2317000660213, 18.242743231244106],
                  [131.2315779957088, 18.240057684369106],
                  [131.21924889414618, 18.246039129681662],
                  [131.08594811289618, 18.350165106244134],
                  [131.0637313160213, 18.3599917664003],
                  [130.99561608164635, 18.358099676556577],
                  [130.99158776133385, 18.3599917664003],
                  [130.98231041758373, 18.384100653119134],
                  [130.97877037852118, 18.448736883587856],
                  [130.9921981128963, 18.60871002811905],
                  [130.98829186289618, 18.66962311405672],
                  [130.96119225352118, 18.764105535931606],
                  [130.9583846363338, 18.784796453900356],
                  [130.95984948008368, 18.8024966492128],
                  [130.96766198008368, 18.815985418744106],
                  [130.97120201914635, 18.817450262494134],
                  [131.00733483164618, 18.813849188275412],
                  [131.01270592539618, 18.814215399212884],
                  [131.01563561289635, 18.815985418744106],
                  [131.02784264414635, 18.844732977337884],
                  [131.04053795664618, 18.932196356244162],
                  [131.04822838633385, 18.94989655155652],
                  [131.06299889414623, 18.966986395306634],
                  [131.13379967539618, 19.011664129681492],
                  [131.14881432383373, 19.01801178593155],
                  [131.16529381602118, 19.021673895306577],
                  [131.18397057383368, 19.021734930462884],
                  [131.2058211597713, 19.017462469525412],
                  [131.27967369883373, 18.98395416874422],
                  [131.2729598316463, 18.986273504681662],
                  [131.2773543628963, 18.97632477421297],
                  [131.36536705820868, 18.87055084843152],
                  [131.37574303477135, 18.863959051556606],
                  [131.4360457691463, 18.866217352337827],
                  [131.46314537852123, 18.87287018436905],
                  [131.48719323008373, 18.883124090619106],
                  [131.50782311289618, 18.897040106243992],
                  [131.5245467457088, 18.9144351257753],
                  [131.53663170664618, 18.9354312195253],
                  [131.54358971445885, 18.96002838749405],
                  [131.5412703785213, 18.99396393436902],
                  [131.5245467457088, 19.020941473431606],
                  [131.49805748789623, 19.0426089539003],
                  [131.40479576914623, 19.09198639530652],
                  [131.38392174570885, 19.10858795780652],
                  [131.37574303477135, 19.127997137494162],
                  [131.37916100352135, 19.13703034061905],
                  [131.38917076914623, 19.143377996869106],
                  [131.4680281910213, 19.157721258587884],
                  [131.47669518320873, 19.162054754681577],
                  [131.48572838633368, 19.172980047650384],
                  [131.49805748789623, 19.199042059369162],
                  [131.51734459727123, 19.37018463749422],
                  [131.4806014332088, 19.598089910931606],
                  [131.4530135425838, 19.6695620789003],
                  [131.43970787852123, 19.689032293744162],
                  [131.42359459727135, 19.703985907025384],
                  [131.41871178477123, 19.705633856244162],
                  [131.38221276133385, 19.711432196087884],
                  [131.37574303477135, 19.714972235150412],
                  [131.37317955820868, 19.720343328900327],
                  [131.37574303477135, 19.727972723431577],
                  [131.38965905039635, 19.737189032025384],
                  [131.4146834644588, 19.74127838749405],
                  [131.4849959644588, 19.73401520390027],
                  [131.52393639414635, 19.722540594525356],
                  [131.56080162852123, 19.705755926556606],
                  [131.59241783945885, 19.683600164837912],
                  [131.61573326914623, 19.655951239056662],
                  [131.62659752695868, 19.632025457806577],
                  [131.62867272227135, 19.61365387577527],
                  [131.62427819102135, 19.59839508671277],
                  [131.59730065195868, 19.54852936405672],
                  [131.59156334727118, 19.522528387494162],
                  [131.5916854175838, 19.48798248905655],
                  [131.59815514414635, 19.450812078900412],
                  [131.6084090503963, 19.422247625775356],
                  [131.65674889414623, 19.354132391400327],
                  [131.66297448008385, 19.338690496869106],
                  [131.6635848316463, 19.320013739056606],
                  [131.65223229258368, 19.29608795780652],
                  [131.56495201914635, 19.194647528119162],
                  [131.53968346445868, 19.152594305462912],
                  [131.52747643320868, 19.107123114056577],
                  [131.53467858164623, 19.058783270306606],
                  [131.56763756602135, 19.008002020306634],
                  [131.61329186289623, 18.98615143436905],
                  [131.61573326914623, 18.98395416874422],
                  [131.62720787852123, 18.90167877811905],
                  [131.63648522227135, 18.883307196087742],
                  [131.65235436289623, 18.872626043743992],
                  [131.67689049570885, 18.8730532898378],
                  [131.71168053477123, 18.888006903119106],
                  [131.7216903003963, 18.895697332806492],
                  [131.73023522227118, 18.905585028119134],
                  [131.76075280039618, 18.95770905155652],
                  [131.78956139414618, 18.989996649212912],
                  [131.79334557383373, 18.99567291874402],
                  [131.79981530039623, 19.0181948914003],
                  [131.80274498789618, 19.024786688275384],
                  [131.84620201914618, 19.080328680462742],
                  [131.85621178477135, 19.08685944218155],
                  [131.8664656910213, 19.086554266400356],
                  [131.87708580820868, 19.07807037968152],
                  [131.90357506602123, 19.032049871869162],
                  [131.92518151133368, 18.964178778119106],
                  [131.92774498789635, 18.96002838749405],
                  [131.9441024097713, 18.949591375775356],
                  [131.9626570972713, 18.94275543827547],
                  [132.00159752695873, 18.936896063275242],
                  [132.0434676441463, 18.936712957806606],
                  [132.04761803477118, 18.936041571087827],
                  [132.0603133472713, 18.906195379681492],
                  [132.06373131602135, 18.873114324994106],
                  [132.0448104175838, 18.728399969525412],
                  [132.04725182383368, 18.694464422650242],
                  [132.05836022227135, 18.663336492962884],
                  [132.0799666675838, 18.640875555462742],
                  [132.11292565195885, 18.623663641400384],
                  [132.19971764414635, 18.604620672650412],
                  [132.29127037852135, 18.605108953900327],
                  [132.33008873789618, 18.612372137494106],
                  [132.35962975352123, 18.62396881718155],
                  [132.40735924570868, 18.670172430462856],
                  [132.40772545664618, 18.672064520306577],
                  [132.43128502695885, 18.671087957806662],
                  [132.63392174570868, 18.6258609070253],
                  [132.69459069102118, 18.62604401249405],
                  [132.77125084727118, 18.65235016483777],
                  [132.78174889414618, 18.652472235150384],
                  [132.79163658945873, 18.648016668744077],
                  [132.78699791758385, 18.647162176556492],
                  [132.78260338633385, 18.638922430462884],
                  [132.77027428477123, 18.554571844525327],
                  [132.73560631602118, 18.556280828900327],
                  [132.56409752695873, 18.59955475468155],
                  [132.52283776133385, 18.598273016400356],
                  [132.4859725269588, 18.58386871952527],
                  [132.45557701914623, 18.551947332806634],
                  [132.45264733164635, 18.533026434369106],
                  [132.46277916758368, 18.454657293744106],
                  [132.48975670664618, 18.36017487186905],
                  [132.50818932383373, 18.321173407025384],
                  [132.52906334727118, 18.295233465619134],
                  [132.5516463550838, 18.288031317181606],
                  [132.59559166758368, 18.298773504681662],
                  [132.65760338633368, 18.324530340619077],
                  [132.67896569102118, 18.325751043744134],
                  [132.69239342539635, 18.31915924686905],
                  [132.71253502695868, 18.29608795780655],
                  [132.72803795664635, 18.286505438275356],
                  [132.7530623707088, 18.282660223431662],
                  [132.79163658945873, 18.288031317181606],
                  [132.79737389414623, 18.292608953900356],
                  [132.82728112070873, 18.354498602337856],
                  [132.83338463633373, 18.360602117962856],
                  [132.83961022227135, 18.3599917664003],
                  [132.85413658945885, 18.350470282025327],
                  [132.86378014414618, 18.346747137494162]]
polygon = Polygon.new
polygon_source.each do |point|
  polygon.add(Point.new(point[0], point[1]))
end
all_polygons.push(polygon)

all_polygons.each do |polygon|
  puts "triangle: check #{polygon.length} -> " +
    "#{triangulate_heap(polygon).length}"
  [0.000001, 0.0001, 0.25, 0.75].each do |threshold|
    new_polygon = polygon.copy
    simplify_polygon_heap(new_polygon, threshold)
    puts "simplification #{threshold}: check #{polygon.length} -> " +
      "#{new_polygon.length}"
    puts "checking polygon"
    validate_polygon(new_polygon)
    check = validate_triangulation(triangulate_heap(new_polygon))
    puts "checking triangles #{check}"
  end
end
